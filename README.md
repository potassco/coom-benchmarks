# COOM Parser and Encoding
A parser to translate COOM DSL into ASP facts
plus a corresponding encoding.

## Installation
For the parser install ANTLR4 for python
```
pip install antlr4-tools
pip install antlr4-python3-runtime==4.9.3
```

The `model` directory contains is provided by denkbares and represents the current state of the COOM DSL language.
The specific version requirement stems from the fact that these files were created with ANTLR4 4.9.3.

More information on the ANTLR4 python target can be found [here](https://github.com/antlr/antlr4/blob/master/doc/python-target.md).

## Usage
### Parser
To parse a `.coom` file you can run the auxiliary script
```
./parse.sh examples/coom/kids-bike.coom
```
This will automatically save the file as an ASP instance in the `examples/asp` folder.

The script makes use of the python script `parser/parse.py` which itself just prints the ASP facts to the console.

> If you get the following error `Exception: Could not deserialize ATN with version  (expected 4).', check that you have the correct antlr4-python-runtime version installed (currently 4.9.3).

### Testing
To test the parser run
```
python -m unittest tests/test_parser.py
```
TODO: Fix testing with new folder structure


### Solving
The files generated by the parser are located in the `examples/asp` directory.
There are three encodings with different levels of features.
They are modular in the sense that the encoding for the city bike
imports all rules from the kids bike encoding and the travel bike
imports all rules from the kids and city bike.

The `encodings/clingo-kids.lp` contains all features of the kids bike.
To run
```
clingo encodings-clingo-kids.lp examples/asp/kids-bike.lp
```

Similarly, for the city and travel bike run
```
clingo encodings/clingo-city.lp examples/asp/city-bike.lp
```
```
clingo encodings/clingo-travel.lp examples/asp/travel-bike.lp
```

> *Note:* Due to the modularity the encodings are downward compatible, i.e.,
you can solve the kids bike with the travel or city bike encoding as well.

#### fclingo
The `fclingo` solver allows hybrid ASP reasoning
combined with founded conditional linear constraints.
This makes it possible to reason over (large) numeric domains
which are frequent in configuration problems.
To install `fclingo` follow the instructions in the corresponding [repository](https://github.com/potassco/fclingo).

Like the `clingo` encodings the `fclingo` encodings are built in a modular structure
```
fclingo encodings/fclingo-kids.lp examples/asp/kids-bike.lp 0
fclingo encodings/fclingo-city.lp examples/asp/city-bike.lp 0
fclingo encodings/fclingo-travel.lp examples/asp/travel-bike.lp 0
```

## Documentation
For a documentation of the fact format see [FactFormat.md](FactFormat.md).

## Design decisions and open topics
- How to handle SI units?
    - Should there be a conversion by the parser to some base unit? Simple to implement but maybe an advanced feature which we do not want in the paper
    - Or should all numerics be specified without SI units, thus in the same unit?
    - Or allow different units and user has to build in conversion into constraint, e.g., for travel bike?
- COOM allows nesting of conditions and requires. This is not supported by parser and encoding currently.
- COOM allows pointing to specific instances (e.g., first bag of carrier), although,
    this is not documented in the Quick Guide I found.
    Currently, the parser does not support this feature.
- Use of wildcards in tables is not supported
- forbid statement in tables is not supported
- Encoding assumes that there is one possible attribute at the end of a path / paths point only to one value
- Assumes that enumeration features have cardinality 1
- Assumes that constant and numbers appear only on the right hand side of a binary relation
- Paths starting with `root.foo` are not supported
- How should arithmetics with undefined terms be handled?

### fclingo
- Currently no division. Is this supported in fclingo?
- fclingo only supports linear constraints, so multiplication is only allowed
  if one of the terms is a  constant number
- Only if attributes are marked as numeric, fclingo will use treat them as such.
  Outside of tables it is not possible to compare non-numeric with numeric attributes.
- How should arithmetics with undefined terms be handled?
